---
tags: メソッド, Flink, 耐障害性, リカバリ戦略, 分散システム, FLIP-1
aliases: Fallback Recovery Strategy (Fine-grained), Failure Rate Evaluation
---

# メソッド/Flink フォールバックリカバリ(細粒度)

## 概要
フォールバックリカバリは、[[モデル/Flink 細粒度リカバリモデル]]を採用している状況において、特定の条件下では細粒度リカバリ（[[メソッド/Flink リージョンベースリカバリ]]）が非効率または不適切であると判断された場合に、従来の[[モデル/Flink 粗粒度リカバリモデル]]（All-or-nothing）に自動的に切り替える（フォールバックする）ための戦略・メソッドです。

## 前提となるモデル/理論(L1)とコンテキスト
* **モデル(L1):** [[モデル/Flink 細粒度リカバリモデル]], [[モデル/Flink 粗粒度リカバリモデル]]
* **メソッド(L2):** [[メソッド/Flink リージョンベースリカバリ]]
* **コンテキスト:** 細粒度リカバリは一般的に効率が良いですが、以下のような特定の状況では逆効果になる可能性があります。
    * **障害の頻発:** 特定のリージョンでタスク障害が短期間に何度も発生する場合、リージョンの再起動を繰り返すよりも、一度ジョブ全体をリセット（粗粒度リカバリ）した方が結果的に早く安定する可能性があります。
    * **根本的な問題:** タスク障害の原因が一時的なものではなく、コードのバグやデータ破損など、ジョブ全体に影響する根本的な問題である場合、部分的な再起動では解決せず、全体を再起動する必要があるかもしれません。
    * **リカバリ調整のオーバーヘッド:** 非常に細かいリージョン分割が行われている場合、頻繁な部分リカバリの調整コストが無視できなくなる可能性があります。

## 具体的な手順・考慮事項
1.  **障害率の監視 (Failure Rate Evaluation):**
    * ジョブマスターは、各タスクまたは各リージョンにおける障害の発生率や頻度を監視します。
    * 例えば、「過去X分間にY回以上の障害が同一リージョンで発生した場合」などの閾値を設定します。
2.  **フォールバックのトリガー:**
    * 監視している障害率が設定された閾値を超えた場合に、フォールバックメカニズムがトリガーされます。
3.  **リカバリ戦略の切り替え:**
    * トリガーされると、次回の障害発生時（または即座に）、ジョブマスターはリージョンベースのリカバリを試みる代わりに、ジョブ全体のタスクをキャンセルし、最後のグローバルチェックポイントから全タスクを再起動する[[モデル/Flink 粗粒度リカバリモデル]]を実行します。
4.  **設定可能性:**
    * フォールバックを有効にするかどうか、障害率の閾値などをユーザーが設定可能にする必要があります。これにより、ジョブの特性や実行環境に応じて最適な挙動を選択できます。
5.  **状態のリセット:**
    * 粗粒度リカバリにフォールバックした場合、細粒度リカバリのために保持されていた中間結果（[[メソッド/Flink 結果パーティション管理(細粒度リカバリ)]]）などは不要になるため、適切にクリーンアップされる必要があります。

このフォールバック戦略により、Flinkは細粒度リカバリの利点を享受しつつ、それが不適切になった場合に自動的に堅牢な全体リカバリに切り替えることで、より安定したジョブ実行を提供することを目指します。