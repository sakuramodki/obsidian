---
tags: メソッド, ApacheFlink, ストリーム処理, 時間管理, 集計
aliases: Flink Windowing
---

# メソッド: Flink ウィンドウ処理 (Windowing)

## 概要
Flinkのウィンドウ処理は、[[モデル/Boundedストリーム vs Unboundedストリーム]]のうち、特にUnboundedストリーム（無限ストリーム）を有限の「ウィンドウ」と呼ばれる区間に分割し、その区間内の要素に対して集計などの計算を行うための仕組みです。

## 前提となるモデル/理論(L1)とコンテキスト
* **L1モデル:** [[モデル/ストリーム処理(データ)]], [[モデル/ステートフルコンピューティング]], [[モデル/ストリーム処理における時間概念]], [[モデル/Boundedストリーム vs Unboundedストリーム]] (主にUnbounded)
* **コンテキスト:**
    * **目的:** 連続的なデータストリームに対して、特定の期間や件数ごと（例: 過去5分間、直近100件）の集計、分析を行いたい。
    * **状況:** 無限に続く可能性のあるデータストリームを扱う必要がある。単純なイベントごとの処理ではなく、あるまとまりに基づいた計算が必要。

## 具体的な手順・考慮事項
1.  **キーストリーム化 (`keyBy()`):** ウィンドウ処理は通常、キーごとに状態を持つため、事前に`keyBy()`でストリームをキーに基づいて分割します。
2.  **ウィンドウアサイナ (Window Assigner) の指定:** どのようにストリームをウィンドウに分割するかを定義します。
    * **Tumbling Windows (タンブリングウィンドウ):** 固定長の、重複しないウィンドウ（例: `TumblingEventTimeWindows.of(Time.minutes(5))` - 5分ごとのイベント時間ウィンドウ）。
    * **Sliding Windows (スライディングウィンドウ):** 固定長の、重複するウィンドウ（例: `SlidingProcessingTimeWindows.of(Time.hours(1), Time.minutes(10))` - 1時間長のウィンドウを10分ごとにスライドさせる処理時間ウィンドウ）。
    * **Session Windows (セッションウィンドウ):** アクティビティがない期間（ギャップ）に基づいて動的にウィンドウを決定する（例: `EventTimeSessionWindows.withGap(Time.minutes(30))` - 30分間イベントがなければセッション終了）。
    * **Global Windows (グローバルウィンドウ):** 全ての要素を単一のグローバルウィンドウに割り当てる。通常、カスタムトリガーと組み合わせて使う。
3.  **ウィンドウ関数 (Window Function) の適用:** 各ウィンドウに属する要素に対して実行される計算ロジックを定義します。
    * **ReduceFunction:** ウィンドウ内の要素を逐次的に結合して単一の結果を生成する（効率的）。
    * **AggregateFunction:** `ReduceFunction`より汎用的で、アキュムレータを使って集計し、最終結果を生成する（効率的）。
    * **ProcessWindowFunction:** ウィンドウ内の全要素と、ウィンドウに関するメタ情報（開始/終了時刻など）にアクセスできる最も柔軟な関数。ただし、全要素をメモリに保持するためリソース消費が大きい。`ReduceFunction`や`AggregateFunction`と組み合わせて効率化可能。
4.  **オプション:**
    * **トリガー (Trigger):** ウィンドウ関数をいつ実行するか（例: ウィンドウ終了時、要素到着ごと）を制御する。デフォルトトリガーがあるがカスタムも可能。
    * **エビクター (Evictor):** ウィンドウ関数実行前に、ウィンドウから要素を削除するロジック（あまり使われない）。
    * **遅延データ処理 (Allowed Lateness):** イベント時間ウィンドウで、ウォーターマーク通過後に到着した遅延データを処理するための許容時間を設定できる。
    * **サイドアウトプット (Side Output):** 遅延データなど、メインの処理結果とは別に特定のデータを別のストリームとして出力できる。
5.  **考慮事項:**
    * **時間セマンティクス:** イベント時間ウィンドウか処理時間ウィンドウかを選択する。[[モデル/ストリーム処理における時間概念]]を理解することが重要。イベント時間を使う場合はウォーターマークの設定が必要。
    * **パフォーマンスとリソース:** `ProcessWindowFunction`は柔軟だがメモリ消費が大きい。可能な限り`ReduceFunction`や`AggregateFunction`を使うことを検討する。ウィンドウサイズやスライド間隔も影響する。
    * **状態管理:** ウィンドウ処理は内部的に[[メソッド/Flink_状態管理]]を使用しており、状態バックエンドの設定が影響する。