---
tags: メソッド, Flink, 耐障害性, リファクタリング, 分散システム, FLIP-1
aliases: Execution Graph Componentization
---

# メソッド/Flink 実行グラフコンポーネント化

## 概要
実行グラフのコンポーネント化は、[[モデル/Flink 細粒度リカバリモデル]]、特に[[メソッド/Flink リージョンベースリカバリ]]を実装可能にするための、Flink内部アーキテクチャに対するリファクタリング手法です。具体的には、実行グラフ(`ExecutionGraph`)とその構成要素（`ExecutionVertex`, `IntermediateResultPartition`など）をより明確に分離・識別可能にし、状態の保持や部分的な再起動を容易にすることを目的とします。

## 前提となるモデル/理論(L1)とコンテキスト
* **モデル(L1):** [[モデル/Flink 細粒度リカバリモデル]]
* **コンテキスト:** 従来のFlinkの実行グラフ実装(`DefaultExecutionGraph`)は、ジョブ全体の状態と密結合しており、部分的なリカバリ（特定のリージョンやタスクのみの再起動）を行う上で柔軟性に欠けていました。細粒度リカバリを実現するには、実行グラフの構造をよりモジュール化し、個々のコンポーネントの状態を独立して管理・操作できるようにする必要がありました。

## 具体的な手順・考慮事項
FLIP-1で提案された主な変更点は以下の通りです。

1.  **ExecutionGraphインターフェース化:**
    * `DefaultExecutionGraph`から`ExecutionGraph`インターフェースを抽出し、実装の詳細を隠蔽します。
    * ジョブ完了後や失敗後に参照されるアーカイブされた実行グラフ(`ArchivedExecutionGraph`)を導入し、実行中のグラフとは分離します。
2.  **コンポーネントの識別可能性:**
    * `ExecutionVertex`, `IntermediateResult`, `IntermediateResultPartition` といった主要なコンポーネントに、ジョブ実行中に一意かつ安定したID（`ExecutionVertexID`, `IntermediateResultPartitionID`など）を付与します。これにより、ジョブマスターやタスクマネージャー間でこれらのコンポーネントを一貫して参照できます。
3.  **状態管理の分離:**
    * 各コンポーネント（特に`ExecutionVertex`や`IntermediateResultPartition`）の状態（スケジュール済み、実行中、完了、失敗など）を、他のコンポーネントから独立して管理・追跡できるようにします。
4.  **再利用可能性:**
    * リージョンベースリカバリにおいて、失敗しなかった上流リージョンの`IntermediateResultPartition`の状態（完了状態やデータの場所など）を保持し、再起動する下流タスクから再利用できるようにします。（関連メソッド: [[メソッド/Flink 結果パーティション管理(細粒度リカバリ)]]）
5.  **APIの整理:**
    * 実行グラフやそのコンポーネントを操作するための内部APIを整理し、部分的なキャンセルや再スケジュールといった操作をサポートできるようにします。

これらのコンポーネント化により、Flinkのスケジューラやジョブマスターは、実行グラフ全体ではなく、特定のリージョンやタスク、中間結果といった細かい単位で状態を把握し、操作することが可能になり、細粒度リカバリの実現基盤が整いました。