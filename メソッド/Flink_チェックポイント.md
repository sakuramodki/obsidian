---
tags: メソッド, ApacheFlink, 耐障害性, ストリーム処理, ステートフルコンピューティング
aliases: Flink Checkpointing
---

# メソッド: Flink チェックポイント (Checkpointing)

## 概要
Flinkのチェックポイントは、[[モデル/ステートフルコンピューティング]]を行うストリーム処理アプリケーションにおいて、耐障害性を実現するためのコアとなるメカニズムです。アプリケーションの状態と入力ストリームの読み取り位置のスナップショットを定期的に永続ストレージに保存します。

## 前提となるモデル/理論(L1)とコンテキスト
* **L1モデル:** [[モデル/ステートフルコンピューティング]], [[モデル/ストリーム処理(データ)]], [[モデル/分散ストリーム処理アーキテクチャ(Flink)]], 耐障害性の概念
* **コンテキスト:**
    * **目的:** 長時間実行されるステートフルなストリーム処理アプリケーションが、途中でタスクマネージャーの障害などが発生しても、状態を失うことなく、一貫性を保ちながら処理を再開できるようにしたい。Exactly-OnceまたはAt-Least-Onceの処理セマンティクスを保証したい。
    * **状況:** アプリケーションが状態を保持している([[モデル/ステートフルコンピューティング]])。24時間365日のような連続稼働が求められる。部分的な障害が発生する可能性がある分散環境([[モデル/分散ストリーム処理アーキテクチャ(Flink)]])で実行される。

## 具体的な手順・考慮事項
1.  **有効化と設定:**
    * `StreamExecutionEnvironment`でチェックポイントを有効化 (`enableCheckpointing(intervalMillis)`)。
    * チェックポイントモード (CheckpointingMode) を設定 (`EXACTLY_ONCE` または `AT_LEAST_ONCE`)。Exactly-Onceが推奨されることが多い。
    * チェックポイントのタイムアウト、同時実行数、永続化ストレージのパスなどを設定。
    * 状態バックエンド ([[メソッド/Flink_状態管理]]参照) を設定。チェックポイントのパフォーマンスに影響する。
2.  **チェックポイント処理の流れ (内部動作):**
    * JobManagerが定期的にチェックポイントコーディネーターを通じて、各ソースタスクに「チェックポイントバリア」を送信するよう指示。
    * バリアはデータストリームに混じって下流のオペレータに流れる。
    * 各オペレータは、全ての入力ストリームからバリアを受け取ると、自身の状態のスナップショットを状態バックエンド (最終的には永続ストレージ) に非同期で書き出す。その後、バリアを下流に流す (アライメント)。
    * Sinkオペレータまでバリアが到達し、全てのオペレータの状態スナップショットが完了したら、JobManagerに完了通知を送る。
    * JobManagerは全ての完了通知を受け取ったら、チェックポイント成功とみなす。
3.  **障害発生時のリカバリ:**
    * TaskManagerの障害などをJobManagerが検知。
    * JobManagerはジョブの実行を停止し、最後に成功したチェックポイントからアプリケーションの状態を復元するよう指示。
    * TaskManagerは永続ストレージから状態をロードし、ソースはチェックポイント時の読み取り位置からデータの再送信を開始する。
    * これにより、状態と入力データの一貫性が保たれたまま処理が再開される。
4.  **セーブポイント (Savepoints):**
    * チェックポイントと技術的には同じだが、ユーザーが手動でトリガーし、ジョブの停止、再開、バージョンアップ、マイグレーションなどの計画的な操作のために使われる。
    * チェックポイントは通常、ジョブ停止時に自動削除されるが、セーブポイントは明示的に削除しない限り残る。
5.  **考慮事項:**
    * **チェックポイント間隔:** 短すぎるとオーバーヘッドが大きくなり、長すぎるとリカバリ時に巻き戻るデータ量が増える。アプリケーションの特性に合わせて調整が必要。
    * **状態サイズ:** 状態が大きいとチェックポイントにかかる時間とリソースが増加する。状態バックエンドの選択や状態の持ち方が重要。
    * **Exactly-Once vs At-Least-Once:** Exactly-Onceは結果の重複を防ぐが、アライメントによるレイテンシ増加の可能性がある。At-Least-Onceはスループットが高い傾向があるが、結果が重複する可能性があるため、Sink側で冪等性を担保するなどの対策が必要な場合がある。
    * **非同期処理:** チェックポイントの大部分はデータ処理と並行して非同期に行われるが、バリアのアライメントなどで一時的に処理がブロックされることがある。