---
tags: メソッド, Flink, 耐障害性, リカバリ戦略, 分散システム, FLIP-1
aliases: Region-based Recovery, Failover Regions
---

# メソッド/Flink リージョンベースリカバリ

## 概要
リージョンベースリカバリは、[[Flink 細粒度リカバリモデル]]を実現するための中心的なメソッドです。Flinkジョブの実行グラフを「リージョン(Region)」または「フェイルオーバーリージョン(Failover Region)」と呼ばれる単位に分割し、タスク障害が発生した際に、影響を受けたリージョン単位でタスクの再起動を行います。

## 前提となるモデル/理論(L1)とコンテキスト
* **モデル(L1):** [[Flink 細粒度リカバリモデル]]
* **コンテキスト:** [[Flink 粗粒度リカバリモデル]]における全体再起動の非効率性を解決し、特に大規模バッチジョブや高並列度ジョブでのリカバリ性能を向上させることを目的としています。タスク障害の影響を局所化したい状況で適用されます。

## 具体的な手順・考慮事項
1.  **実行グラフのリージョン分割:**
    * 実行グラフは、データ交換（エッジ）の種類に基づいてリージョンに分割されます。
    * パイプライン接続（Pipelined）のエッジで接続されたタスク群が一つのリージョンを形成します。
    * ブロッキング（Blocking）のエッジ（例: バッチ処理におけるソートや集約の前後）がリージョンの境界となります。これは、ブロッキングなデータ交換では、上流タスクが全て完了しないと下流タスクが開始できないため、自然な回復の境界となるからです。(FLIP-1文書の "Failover Regions" セクションの図を参照)
2.  **障害発生時のリカバリプロセス:**
    * いずれかのタスクで障害が発生すると、そのタスクが属するリージョンを特定します。
    * そのリージョンに属する**全ての**タスクをキャンセルします。
    * キャンセルされたタスクが必要とする入力データ（上流リージョンからのブロッキングな中間結果）が利用可能であることを確認します。（関連メソッド: [[Flink 結果パーティション管理(細粒度リカバリ)]]）
    * キャンセルされたリージョンのタスクを再スケジュールし、再実行します。
    * 下流のリージョンは、再起動されたリージョンからの新しい結果を待ちます。
3.  **コンポーネント化:**
    * リージョン単位での状態管理や再起動を可能にするため、実行グラフとその構成要素（Vertex, IntermediateResultPartitionなど）が適切に識別・管理できる必要があります。（関連メソッド: [[Flink 実行グラフコンポーネント化]]）
4.  **スケジューリング:**
    * リージョン内のタスクは通常、同時にスケジュールされる必要があります。スケジューラはリージョンという概念を認識する必要があります。
5.  **フォールバック:**
    * 特定のリージョンで障害が頻発する場合など、リージョンベースのリカバリが非効率になるケースも考えられます。その場合は、ジョブ全体の再起動（粗粒度リカバリ）にフォールバックするメカニズムも考慮されます。（関連メソッド: [[Flink フォールバックリカバリ(細粒度)]]）

このメソッドにより、障害の影響を受けていないリージョンのタスクは再実行されることなく、計算結果も保持されるため、リカバリの効率が大幅に向上します。