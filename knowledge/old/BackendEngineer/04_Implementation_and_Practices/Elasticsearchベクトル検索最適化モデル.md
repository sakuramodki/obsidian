# Elasticsearchベクトル検索最適化モデル (Elasticsearch Vector Search Optimization Model)

## モデル概要
ElasticsearchのkNN（最近傍探索）ベクトル検索において、特にフィルター使用時のパフォーマンスを改善するための具体的な技術的最適化手法と、その効果を説明するモデル。

## モデル適用条件
Elasticsearch 8以降のバージョンを使用し、kNNベクトル検索にフィルターを適用する際にパフォーマンスボトルネックが発生しているシステム。

## モデル構造
- **ボトルネックの特定:**
    - JVMヒープ外メモリからヒープ内への不要なデータコピー (`jint_disjoint_arraycopy`, `jlong_disjoint_arraycopy`)。
    - 絞り込みフィルター適用時のHNSWグラフ探索の非効率性 (`HNSWGraphSearcher.search`)。
    - 緩いフィルター適用時のBitSet合成処理のオーバーヘッド (`AbstractKnnVectorQuery.createBitSet`)。
    - ベクトルフィールドが存在しないドキュメントに対するFieldExistQueryのコスト。
- **最適化手法:**
    - **Elasticsearchバージョンアップ:** 8.17.1へのアップデートによる独自のベクトル化モジュール（Panama Vector APIの代替）の活用。
    - **ACORN風アルゴリズムの導入:** 絞り込みフィルター時のHNSWグラフ探索効率化。
    - **BitSet合成の最適化:** 緩いフィルター時のBitSet合成処理の効率化（`intersectionCount`の利用など）。
    - **ベクトルフィールド存在チェックの排除:** ベクトルが存在しないドキュメントをインデックスから排除。

## モデル法則
- ベクトル検索のパフォーマンスは、データコピーの削減、グラフ探索アルゴリズムの最適化、BitSet操作の効率化、および不要なフィールド存在チェックの排除によって大幅に向上する。
- 特にフィルターを伴うベクトル検索では、フィルターの選択性（絞り込み度合い）に応じて異なる最適化アプローチが有効である。

## モデルをもとに期待する効果を得るためのプラクティス
- Elasticsearchのバージョンを最新に保ち、最新のパフォーマンス改善を取り入れる。
- kNN検索にフィルターを使用する場合、フィルターの特性（絞り込み度合い）を考慮し、適切な最適化手法（ACORN風アルゴリズム、BitSet最適化）を適用する。
- ベクトルフィールドは、すべてのドキュメントに存在するようにデータ前処理を行うか、存在しないドキュメントをインデックスから除外することを検討する。
- パフォーマンスプロファイリングツール（async-profilerなど）を用いて、継続的にボトルネックを特定し、改善策を適用する。

## モデル自体の詳細な解説

## 事例紹介

## モデル限界と注意点
- 改善効果はElasticsearchのバージョン、データ特性、クエリパターンに依存する。
- Luceneのupstreamの変更に追従する必要がある。
- リアルタイムなドキュメントの追加/更新/削除がある環境では、パフォーマンス特性が異なる場合がある。

## 関連事例

### 実装事例
- [Elasticsearchのベクトル検索におけるフィルター使用時のパフォーマンス改善 | メルカリエンジニアリング](https://engineering.mercari.com/blog/entry/20250718-03e1dbe909/)
  - メルカリにおけるElasticsearchのkNNベクトル検索のパフォーマンス改善事例。
  - 具体的なボトルネックの特定から、バージョンアップ、アルゴリズム改善、BitSet最適化、データ構造の調整に至る一連の改善プロセスが詳細に解説されている。

### 関連モデル
- [新・単一責任原則モデル](/knowledge/04_Code/BackendEngineer/新・単一責任原則モデル.md) - 効率的なデータ構造と処理は、各コンポーネントの責任を明確にし、パフォーマンスを向上させる。
