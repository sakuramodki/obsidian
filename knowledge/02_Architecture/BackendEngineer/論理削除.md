# 論理削除 (Logical Deletion)

## モデル概要
データベース設計における「論理削除」の概念と、ユーザーリソースの論理削除を扱うための様々なアプローチ、特にアクティブユーザーと削除済みユーザーの扱いが異なる場合の考慮事項について説明するモデル。単に`deleted_at`カラムを追加するだけではない、より深い設計の選択肢と、それがビジネスイベントやデータ整合性に与える影響を体系化する。

## モデル適用条件
*   データベース設計において、データの物理的な削除ではなく、論理的な削除を必要とするシステム。
*   削除されたユーザーやリソースの情報が、ビジネス上の理由（監査、履歴保持、復元可能性など）から保持される必要がある場合。
*   アクティブなデータと削除済みデータの扱いが異なる、または異なるライフサイクルを持つ場合。

## モデル構造
本モデルは以下の主要な考慮事項と実装パターンで構成される。

### 1. リソースの考慮事項
*   アクティブユーザーと削除済みユーザーのモデル化。
*   削除によって属性や振る舞いが変化する場合のサブタイプ利用。

### 2. イベントの考慮事項
*   削除時におけるビジネスイベント（例: 「登録解除」「BAN」）の記録の重要性。
*   単なる`deleted_at`タイムスタンプ以上の、イベント発生時のコンテキストと属性のキャプチャ。

### 3. リソースサブタイプの実装パターン
テーブルにおける継承パターンの議論:
*   **単一テーブル継承 (Single Table Inheritance)**: 全てのユーザータイプを1つのテーブルに格納。
    *   利点: 全ユーザー検索が容易。
    *   欠点: 削除済みユーザーが多い場合のパフォーマンス、ユニーク制約の困難さ、クエリの複雑さ。
*   **具象テーブル継承 (Concrete Table Inheritance)**: 各サブタイプを個別のテーブルに格納。
    *   利点: 削除済みユーザーの個人情報管理が自然、アクティブユーザー検索への影響なし。
    *   欠点: タイプ横断検索にUNIONが必要、外部キー制約の困難さ。
*   **クラステーブル継承 (Class Table Inheritance)**: 共通属性を親テーブル、特定属性を子テーブルに格納。
    *   利点: タイプ横断検索が容易、新規サブタイプ追加が容易。
    *   欠点: O/Rマッパーとの連携が複雑になる可能性。

### 4. イベントとの関係性
ユーザーが論理削除された場合の外部キー関係の扱い、特にユーザーを参照するイベント（例: 注文）の場合。
*   **最新のリソース状態を参照**: イベントが常に最新のユーザー状態を参照する場合。
*   **イベント発生時のリソース状態を保持**: イベント発生時のユーザー状態を保持する必要がある場合。
    *   **スナップショット方式**: ユーザー属性をイベントエンティティにコピー。
        *   利点: 完全な履歴情報、ユーザー削除の影響なし、シンプル。
        *   欠点: データ重複、イベントエンティティの肥大化。
    *   **世代管理方式**: 「ユーザー世代」テーブルで変更履歴を追跡。
        *   利点: 完全な変更履歴、正確な履歴情報、データ重複が最小限。
        *   欠点: 世代管理の複雑さ、世代横断検索のパフォーマンス問題。

## モデル法則
*   論理削除は、単なる`deleted_flag`や`deleted_at`の追加以上の、ビジネスイベントとデータモデルの深い考慮を必要とする。
*   リソースのライフサイクルと、それに関連するビジネスイベントの不変性を考慮することで、より堅牢なデータ設計が可能になる。
*   データの整合性と履歴保持の要件に応じて、適切な継承パターンとイベント関連付け戦略を選択する必要がある。

## モデルをもとに期待する効果を得るためのプラクティス
*   論理削除の要件を明確にする際、単に「削除フラグ」を設けるのではなく、ビジネスイベントとしての「削除」の意味合い（例：退会、アカウント停止）を深く掘り下げる。
*   削除されたデータの利用シナリオ（例：監査、統計、復元）を事前に定義し、それに合わせてデータモデルとアクセスパターンを設計する。
*   データモデルの変更が、既存のイベントや関連データに与える影響を常に考慮し、後方互換性を維持する戦略を立てる。
*   特に履歴保持が必要な場合は、スナップショット方式や世代管理方式の導入を検討し、データ重複とクエリパフォーマンスのトレードオフを評価する。

## モデル自体の詳細な解説
本モデルは、データベースにおける論理削除の概念を、単なる技術的な実装詳細に留まらず、ビジネス要件、データ整合性、そして長期的なシステム運用という観点から多角的に分析する。特に、データの不変性（immutability）とイベントソーシングの原則が、論理削除の設計にどのように影響するかを強調している。

## 事例紹介
（元の記事には具体的な事例の記載がないため、ここでは割愛します。必要であれば、後で追加できます。）

## モデル限界と注意点
*   本モデルで提示されるパターンは、システムやビジネス要件によって最適な選択が異なる。
*   複雑な世代管理やスナップショット方式は、実装コストと運用コストが増大する可能性がある。
*   パフォーマンス要件が非常に厳しいシステムでは、論理削除のオーバーヘッドが問題となる場合がある。
*   GDPRなどのデータプライバシー規制への対応は、論理削除だけでは不十分な場合があり、物理削除や匿名化の検討も必要となる。

## 関連事例

### 技術詳細事例
- [論理削除 - kawasima](https://scrapbox.io/kawasima/%E8%AB%96%E7%90%86%E5%89%8A%E9%99%A4)
  - データベース設計における論理削除の様々なアプローチと考慮事項について詳細に解説。
