分類: #事例 #ブログ

# 関連情報
URL : https://techblog.lycorp.co.jp/ja/20250424icq
# コンテキスト
[[ユニットテスト]]における実装失敗パターン

# 要約
モックやスタブを使う場合、次のリスクが存在する。
1. **テストの複雑化**: 単純な操作まで注入可能にすると、テストを実行するために必要となるモックやスタブが増えてしまい、複雑なセットアップロジックが必要になる。また、テスト対象のコードが変更されると、テストにも大幅な更新が必要になることもあり、保守のコストが増加しやすい。
2. **統合テストの不足**: ロジックを過剰にモックやスタブに置き換えると、依存先のロジックとの相互作用が検証できなくなる。上記のテストでは、実際の `FooModel` の値は一切使われていないため、値と出力される文字列が正しく対応が取れているかの確認ができていない。特に、依存先のロジックの仕様が変わった場合など、モックやスタブの想定と実際の挙動がズレてしまった時でもテストが通ってしまい、バグを見逃してしまう可能性がある。

例えば次のような場合には、モックやスタブを使った方が良い。
- 実行環境や外部環境に依存する場合 (例: Locale 固有のロジック, Network API Client)
- 再現性を保証できない場合 (例: 乱数, 現在時刻)
- 実行に時間がかかる、またはリソースを多く消費する場合
- インスタンス化やセットアップ、リセットに複雑な手順が必要な場合
- 状態遷移やロジックが複雑で、単純なテストでは扱いにくい場合
- 依存先のコードが多くのレイヤーやモジュールにまたがり、テストが広範囲になりすぎる場合
- 依存先のコードの仕様が固まっているが、まだ実装中で完成していない場合

